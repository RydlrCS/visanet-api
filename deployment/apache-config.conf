<VirtualHost *:80>
    ServerName locapay.rydlr.com
    ServerAdmin admin@rydlr.com

    # Redirect all HTTP to HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

<VirtualHost *:443>
    ServerName locapay.rydlr.com
    ServerAdmin admin@rydlr.com

    DocumentRoot /home/rydlr/domains/locapay.rydlr.com/public_html

    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /home/rydlr/domains/locapay.rydlr.com/ssl/cert.pem
    SSLCertificateKeyFile /home/rydlr/domains/locapay.rydlr.com/ssl/key.pem
    SSLCertificateChainFile /home/rydlr/domains/locapay.rydlr.com/ssl/chain.pem

    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline';"

    # Enable mod_proxy modules
    # Requires: a2enmod proxy proxy_http proxy_wstunnel headers rewrite ssl

    # Proxy WebSocket connections
    RewriteEngine On
    RewriteCond %{HTTP:Upgrade} =websocket [NC]
    RewriteRule /(.*)           ws://localhost:3000/$1 [P,L]
    RewriteCond %{HTTP:Upgrade} !=websocket [NC]
    RewriteRule /(.*)           http://localhost:3000/$1 [P,L]

    # Proxy API requests to Node.js backend
    ProxyPreserveHost On
    ProxyPass /api http://localhost:3000/api
    ProxyPassReverse /api http://localhost:3000/api

    # Proxy authentication routes
    ProxyPass /auth http://localhost:3000/auth
    ProxyPassReverse /auth http://localhost:3000/auth

    # Proxy webhooks
    ProxyPass /webhooks http://localhost:3000/webhooks
    ProxyPassReverse /webhooks http://localhost:3000/webhooks

    # Serve static frontend files
    <Directory /home/rydlr/domains/locapay.rydlr.com/public_html>
        Options -Indexes +FollowSymLinks
        AllowOverride All
        Require all granted

        # Frontend routing - redirect all non-file requests to index.html
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
    </Directory>

    # Error and Access Logs
    ErrorLog /home/rydlr/domains/locapay.rydlr.com/logs/apache-error.log
    CustomLog /home/rydlr/domains/locapay.rydlr.com/logs/apache-access.log combined

    # Compress responses
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript application/javascript application/json
    </IfModule>

    # Cache static assets
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType text/css "access plus 1 month"
        ExpiresByType application/javascript "access plus 1 month"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"
    </IfModule>
</VirtualHost>
